<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FitTakip Pro Final</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        /* --- MODERN TEMA DEƒûƒ∞≈ûKENLERƒ∞ --- */
        :root {
            --primary-grad: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --accent: #FF6B6B;
            --bg: #f0f2f5;
            --surface: #ffffff;
            --text-main: #2d3436;
            --text-sub: #636e72;
            --border: #dfe6e9;
            --shadow: 0 10px 20px rgba(0,0,0,0.05);
            --radius: 20px;
            --nav-height: 70px;
        }

        [data-theme="dark"] {
            --primary-grad: linear-gradient(135deg, #3a4b8a 0%, #462c63 100%);
            --bg: #121212;
            --surface: #1e1e1e;
            --text-main: #f5f6fa;
            --text-sub: #b2bec3;
            --border: #2d3436;
            --shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0; padding: 0;
            padding-bottom: calc(var(--nav-height) + 20px);
            transition: background 0.3s, color 0.3s;
        }

        /* --- BUTONLAR --- */
        .btn-grad {
            background-image: var(--primary-grad);
            border: none; border-radius: 12px; color: white;
            padding: 15px; width: 100%; font-size: 16px; font-weight: 600;
            box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4);
            cursor: pointer; transition: transform 0.2s;
        }
        .btn-grad:active { transform: scale(0.98); }
        
        .btn-outline {
            background: transparent; border: 2px solid #764ba2;
            color: #764ba2; border-radius: 12px; padding: 14px; width: 100%;
            font-weight: 600; cursor: pointer;
        }
        [data-theme="dark"] .btn-outline { border-color: #a29bfe; color: #a29bfe; }

        .icon-btn {
            background: var(--surface); border: none; width: 40px; height: 40px;
            border-radius: 50%; box-shadow: var(--shadow); color: var(--text-main);
            font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        /* --- Gƒ∞Rƒ∞≈û SAYFASI --- */
        #loginPage {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 30px;
        }
        .login-hero {
            background: var(--surface); padding: 40px 30px; border-radius: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1); width: 100%; max-width: 400px;
            text-align: center; position: relative; overflow: hidden;
        }
        .login-hero::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 6px;
            background: var(--primary-grad);
        }
        .app-logo { font-size: 50px; margin-bottom: 10px; display: block; }
        .login-hero h1 { margin: 10px 0; font-size: 28px; color: var(--text-main); }
        .login-hero p { color: var(--text-sub); margin-bottom: 30px; font-size: 14px; }
        
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group input {
            width: 100%; padding: 15px; border-radius: 12px;
            border: 1px solid var(--border); background: var(--bg);
            color: var(--text-main); font-family: inherit; outline: none;
            transition: 0.3s;
        }
        .input-group input:focus { border-color: #764ba2; box-shadow: 0 0 0 3px rgba(118, 75, 162, 0.1); }

        /* --- √úST HEADER --- */
        header {
            padding: 20px; display: flex; align-items: center; justify-content: space-between;
            background: transparent; max-width: 600px; margin: 0 auto;
        }
        .header-title h2 { margin: 0; font-size: 24px; font-weight: 700; }
        .header-title span { font-size: 12px; color: var(--text-sub); display: block; }

        /* --- DURUM G√ñSTERGESƒ∞ (KAYDEDƒ∞Lƒ∞YOR) --- */
        #status-indicator {
            position: fixed; top: 15px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 5px 15px;
            border-radius: 20px; font-size: 11px; z-index: 2000;
            display: none; pointer-events: none;
        }

        /* --- ALT MEN√ú --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height);
            background: var(--surface);
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 500; border-top-left-radius: 25px; border-top-right-radius: 25px;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-sub); font-size: 10px; gap: 4px; text-decoration: none;
            width: 25%; height: 100%; transition: 0.2s;
        }
        .nav-item i { font-size: 24px; font-style: normal; }
        .nav-item.active { color: #764ba2; font-weight: 700; }
        .nav-item.active i { transform: translateY(-3px); }
        [data-theme="dark"] .nav-item.active { color: #a29bfe; }

        /* --- SAYFALAR & KARTLAR --- */
        .page { display: none; padding: 0 20px; max-width: 600px; margin: 0 auto; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card {
            background: var(--surface); border-radius: var(--radius);
            padding: 25px; margin-bottom: 20px;
            box-shadow: var(--shadow); border: 1px solid var(--border);
            position: relative; overflow: hidden;
        }
        .card h2 { margin-top: 0; font-size: 18px; display: flex; align-items: center; gap: 10px; }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; text-align: center; }
        .stat-box strong { font-size: 22px; display: block; color: #764ba2; }
        [data-theme="dark"] .stat-box strong { color: #a29bfe; }
        .stat-box small { color: var(--text-sub); font-size: 12px; text-transform: uppercase; letter-spacing: 1px; }

        .progress-container { background: var(--bg); height: 12px; border-radius: 6px; overflow: hidden; margin-top: 15px; }
        .progress-bar { height: 100%; background: var(--primary-grad); width: 0%; transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); }

        .task-row {
            display: flex; align-items: center; background: var(--bg);
            padding: 15px; border-radius: 12px; margin-bottom: 10px;
            transition: 0.2s;
        }
        .task-row:active { transform: scale(0.98); }
        .checkbox {
            width: 24px; height: 24px; border: 2px solid #764ba2; border-radius: 6px;
            margin-right: 15px; display: flex; align-items: center; justify-content: center;
            cursor: pointer;
        }
        .checked .checkbox { background: #764ba2; }
        .checked .checkbox::after { content: '‚úî'; color: white; font-size: 14px; }
        .checked span { text-decoration: line-through; opacity: 0.5; }

        .error-msg {
            color: #ff6b6b; background: rgba(255, 107, 107, 0.1);
            padding: 10px; border-radius: 8px; font-size: 13px; margin-top: 10px;
            display: none; text-align: left;
        }
        
        .setting-row { margin-bottom: 15px; }
        .setting-row label { display: block; font-size: 13px; color: var(--text-sub); margin-bottom: 5px; }
        .setting-row input, .setting-row select {
            width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border);
            background: var(--bg); color: var(--text-main); font-family: 'Poppins';
        }

    </style>
</head>
<body>

    <div id="status-indicator">Kaydediliyor... ‚òÅÔ∏è</div>

    <div id="loginPage">
        <div style="position: absolute; top:20px; right:20px; display:flex; gap:10px;">
            <button class="icon-btn" onclick="toggleLang()" id="langBtnLogin">TR</button>
            <button class="icon-btn" onclick="toggleThemeGlobal()" id="themeBtnLogin">‚òÄ</button>
        </div>

        <div class="login-hero">
            <span class="app-logo">üî•</span>
            <h1>FitTakip Pro</h1>
            <p id="txt_loginSub">Hedefine ula≈ü, sƒ±nƒ±rlarƒ±nƒ± zorla.</p>

            <div id="auth-forms" style="display:none;">
                <h3 id="form-title" style="text-align:left; margin-bottom:15px;">Giri≈ü Yap</h3>
                <div class="input-group"><input type="email" id="email" placeholder="E-posta"></div>
                <div class="input-group"><input type="password" id="password" placeholder="≈ûifre"></div>
                
                <div id="loginError" class="error-msg"></div>

                <button class="btn-grad" id="btn_action" onclick="performAuth()">Devam Et ‚Üí</button>
                <button onclick="goBack()" style="background:none; border:none; color:var(--text-sub); margin-top:15px; cursor:pointer;">ƒ∞ptal</button>
            </div>

            <div id="welcome-buttons">
                <button class="btn-grad" onclick="showForm('login')" id="btn_welcome_login">Giri≈ü Yap</button>
                <div style="height:15px;"></div>
                <button class="btn-outline" onclick="showForm('register')" id="btn_welcome_reg">Hesap Olu≈ütur</button>
            </div>
        </div>
        <p style="margin-top:20px; font-size:12px; color:var(--text-sub); opacity:0.5;">v12.0 Final Release</p>
    </div>

    <div id="appPage">
        
        <header>
            <div class="header-title">
                <span id="txt_welcome">Ho≈ü geldin,</span>
                <h2 id="userEmailShort">Kullanƒ±cƒ±</h2>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="icon-btn" onclick="toggleLang()" id="langBtnApp">TR</button>
                <button class="icon-btn" onclick="toggleThemeGlobal()" id="themeBtnApp">‚òÄ</button>
            </div>
        </header>

        <div id="dashboard" class="page active">
            
            <div id="weightReminder" class="card" style="background: linear-gradient(to right, #f6d365, #fda085); color:#fff; display:none; border:none;" onclick="switchPage('profile')">
                <div style="display:flex; align-items:center; gap:10px;">
                    <span style="font-size:24px;">‚öñÔ∏è</span>
                    <div><strong style="display:block;">Hatƒ±rlatma</strong><span id="txt_remind" style="font-size:13px; opacity:0.9;">Tartƒ±lma zamanƒ± geldi!</span></div>
                </div>
            </div>

            <div class="card">
                <h2 id="txt_total">G√ºnl√ºk √ñzet üî•</h2>
                <div class="stat-grid">
                    <div class="stat-box"><strong id="totalCal">0</strong><small>TOPLAM</small></div>
                    <div class="stat-box"><strong id="stepCal">0</strong><small id="txt_step">ADIM</small></div>
                    <div class="stat-box"><strong id="sportCal">0</strong><small id="txt_sport">SPOR</small></div>
                </div>
            </div>

            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2 style="margin:0;" id="txt_bodyStat">Durum</h2>
                    <span id="bmiLabel" style="font-size:12px; padding:4px 10px; background:#dfe6e9; border-radius:10px; color:#636e72;">--</span>
                </div>
                <div style="margin-top:15px; display:flex; justify-content:space-between; font-size:14px;">
                    <span><span id="txt_cur">Kilo</span>: <b id="curW">--</b></span>
                    <span><span id="txt_tar">Hedef</span>: <b id="tarW">--</b></span>
                </div>
                <div class="progress-container"><div id="wProg" class="progress-bar"></div></div>
            </div>

            <div class="card">
                <h2 id="txt_todayWork">G√∂revler</h2>
                <div id="taskList"></div>
            </div>

            <div class="card">
                <h2 id="txt_stepCount">Hƒ±zlƒ± Adƒ±m Giri≈üi üëü</h2>
                <div class="input-group">
                    <input type="number" id="dailyStepsInput" placeholder="Adƒ±m sayƒ±sƒ±..." oninput="handleStepInput(this.value)">
                </div>
            </div>
        </div>

        <div id="add-activity" class="page">
            <div class="card">
                <h2 id="txt_addAct">Yeni Aktivite ‚ö°</h2>
                <div class="setting-row"><label>Aktivite Adƒ±</label><input type="text" id="actName" placeholder="√ñrn: Ko≈üu, Y√ºzme..."></div>
                <div class="setting-row"><label>Kalori Deƒüeri (kcal)</label><input type="number" id="actCal" placeholder="0"></div>
                <div class="setting-row"><label>Video Linki (Opsiyonel)</label><input type="url" id="actLink" placeholder="YouTube..."></div>
                <button class="btn-grad" onclick="addNewActivity()" id="btn_addList">Listeye Ekle</button>
            </div>
            <div class="card">
                <h2 id="txt_myList">Kayƒ±tlƒ± Aktivitelerim</h2>
                <div id="manageList"></div>
            </div>
        </div>

        <div id="history" class="page">
            <div class="card">
                <h2 id="txt_histTitle">Ge√ßmi≈ü Kayƒ±tlar üìú</h2>
                <table width="100%" id="historyTable" style="text-align:left; border-collapse:collapse; margin-top:10px;">
                    <thead style="border-bottom:2px solid var(--border); color:var(--text-sub); font-size:12px;">
                        <th style="padding:10px;" id="th_date">Tarih</th><th id="th_step">Adƒ±m</th><th id="th_cal">Kcal</th>
                    </thead>
                    <tbody style="font-size:14px;"></tbody>
                </table>
                <button onclick="clearHistory()" id="btn_clearHist" style="width:100%; margin-top:20px; background:#ff7675; color:white; border:none; padding:10px; border-radius:8px;">Temizle</button>
            </div>
        </div>

        <div id="profile" class="page">
            <div class="card">
                <h2 id="txt_settings">Profil Ayarlarƒ± ‚öôÔ∏è</h2>
                <div class="setting-row"><label id="lbl_height">Boy (cm)</label><input type="number" id="uHeight" oninput="handleProfileInput()"></div>
                <div class="setting-row"><label id="lbl_weight">G√ºncel Kilo (kg)</label><input type="number" id="uWeight" oninput="handleProfileInput(true)"></div>
                <div class="setting-row"><label id="lbl_target">Hedef Kilo (kg)</label><input type="number" id="uTarget" oninput="handleProfileInput()"></div>
                <div class="setting-row">
                    <label id="lbl_freq">Tartƒ±lma Hatƒ±rlatƒ±cƒ±sƒ±</label>
                    <select id="uFreq" onchange="handleProfileInput()">
                        <option value="7">Haftada 1</option>
                        <option value="30">Ayda 1</option>
                    </select>
                </div>
            </div>

            <div class="card" style="border:1px solid #ff7675;">
                <h2 style="color:#ff7675;">Oturum</h2>
                <button class="btn-outline" style="border-color:#ff7675; color:#ff7675;" onclick="endDay()" id="btn_archive">G√ºn√º Bitir</button>
                <div style="height:10px;"></div>
                <button class="btn-outline" style="border-color:#636e72; color:#636e72;" onclick="cikisYap()" id="menu_logout">√áƒ±kƒ±≈ü Yap</button>
            </div>
        </div>

        <nav class="bottom-nav">
            <a href="#" class="nav-item active" onclick="switchPage('dashboard', this)"><i>üè†</i> <span id="menu_home">Ana Sayfa</span></a>
            <a href="#" class="nav-item" onclick="switchPage('add-activity', this)"><i>‚ö°</i> <span id="menu_add">Ekle</span></a>
            <a href="#" class="nav-item" onclick="switchPage('history', this)"><i>üìÖ</i> <span id="menu_history">Ge√ßmi≈ü</span></a>
            <a href="#" class="nav-item" onclick="switchPage('profile', this)"><i>üë§</i> <span id="menu_profile">Profil</span></a>
        </nav>
    </div>

<script>
    // --- FIREBASE BA≈ûLATMA ---
    const firebaseConfig = {
      apiKey: "AIzaSyB656zs8jf-Pib4nDGjzm81EDYsK8WL-Xc",
      authDomain: "fittakipp.firebaseapp.com",
      projectId: "fittakipp",
      storageBucket: "fittakipp.firebasestorage.app",
      messagingSenderId: "526085600537",
      appId: "1:526085600537:web:d56687929540fd932f4188",
      measurementId: "G-81YYJKDC4R"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- VERƒ∞ MODELƒ∞ ---
    const defaultData = {
        activities: [], 
        history: [],
        weight: 0, height: 0, targetWeight: 0, weightFreq: 7, lastWeightUpdate: null,
        dailySteps: 0, // Bu deƒüer veritabanƒ±nda saklanƒ±r
        lastDate: new Date().toLocaleDateString('tr-TR'), 
        theme: 'light', lang: 'tr'
    };

    let appData = JSON.parse(JSON.stringify(defaultData));
    let saveTimeout = null; // Debounce i√ßin zamanlayƒ±cƒ±

    // --- SAYFA Y√úKLENƒ∞NCE ---
    window.onload = function() {
        const localLang = localStorage.getItem('localLang') || 'tr';
        const localTheme = localStorage.getItem('localTheme') || 'light';
        applySettingsToDOM(localLang, localTheme);
    };

    // --- AUTH Y√ñNETƒ∞Mƒ∞ ---
    auth.onAuthStateChanged(user => {
        if (user) {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('appPage').style.display = 'block';
            document.getElementById('userEmailShort').innerText = user.email.split('@')[0];
            loadFromCloud(user.uid);
        } else {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('appPage').style.display = 'none';
        }
    });

    function showForm(mode) {
        document.getElementById('welcome-buttons').style.display = 'none';
        document.getElementById('auth-forms').style.display = 'block';
        window.currentAuthMode = mode;
        const p = langPack[appData.lang || localStorage.getItem('localLang') || 'tr'];
        document.getElementById('form-title').innerText = (mode === 'login') ? p.welcome_login : p.welcome_reg;
        document.getElementById('btn_action').innerText = (mode === 'login') ? p.loginBtn : p.regBtn;
    }
    
    function goBack() {
        document.getElementById('auth-forms').style.display = 'none';
        document.getElementById('welcome-buttons').style.display = 'block';
        document.getElementById('password').value = '';
    }

    function performAuth() {
        const e = document.getElementById('email').value;
        const p = document.getElementById('password').value;
        if(window.currentAuthMode === 'login') {
            auth.signInWithEmailAndPassword(e, p).catch(showError);
        } else {
            auth.createUserWithEmailAndPassword(e, p).then(cred => {
                // Yeni kullanƒ±cƒ± i√ßin bo≈ü veri yaz
                saveToCloudInternal(cred.user.uid, defaultData);
            }).catch(showError);
        }
    }

    function showError(err) {
        const msg = err.message;
        const errBox = document.getElementById('loginError'); errBox.style.display = 'block';
        if (msg.includes('email-already-in-use')) errBox.innerHTML = "‚ö†Ô∏è E-posta zaten kullanƒ±mda.";
        else if (msg.includes('wrong-password')) errBox.innerText = "‚ö†Ô∏è Hatalƒ± ≈üifre.";
        else if (msg.includes('user-not-found')) errBox.innerText = "‚ö†Ô∏è Kullanƒ±cƒ± bulunamadƒ±.";
        else if (msg.includes('weak-password')) errBox.innerText = "‚ö†Ô∏è ≈ûifre √ßok zayƒ±f.";
        else errBox.innerText = "Hata: " + msg;
    }

    function cikisYap() { auth.signOut().then(() => location.reload()); }

    // --- VERƒ∞TABANI ƒ∞≈ûLEMLERƒ∞ (CRITICAL FIX) ---

    // 1. VERƒ∞ OKUMA
    function loadFromCloud(uid) {
        db.collection('users').doc(uid).get().then(doc => {
            if (doc.exists) {
                const data = doc.data();
                // Eksik alanlarƒ± varsayƒ±lanlarla tamamla
                appData = { ...defaultData, ...data };
                
                // Temel ayarlarƒ± uygula
                applySettingsToDOM(appData.lang, appData.theme);
                
                // Kritik: Inputlarƒ± doldur
                fillInputsFromData();
                
                // Hesaplamalarƒ± yap
                calculateStats();
                
                // G√ºn kontrol√º
                checkNewDay();
            } else {
                appData = JSON.parse(JSON.stringify(defaultData));
                saveToCloud(); // ƒ∞lk kez olu≈ütur
                fillInputsFromData();
            }
        });
    }

    // 2. INPUTLARI DOLDURMA (Veriden Ekrana)
    function fillInputsFromData() {
        document.getElementById('dailyStepsInput').value = appData.dailySteps || ""; // 0 yerine bo≈ü g√∂sterilebilir veya 0
        document.getElementById('uHeight').value = appData.height || "";
        document.getElementById('uWeight').value = appData.weight || "";
        document.getElementById('uTarget').value = appData.targetWeight || "";
        document.getElementById('uFreq').value = appData.weightFreq || 7;
        
        renderTasks();
        renderManage();
        renderHistory();
    }

    // 3. AKILLI KAYIT (DEBOUNCE)
    // Her tu≈üa basƒ±ldƒ±ƒüƒ±nda kaydetmek yerine, yazma bitince kaydeder.
    function triggerSave() {
        const indicator = document.getElementById('status-indicator');
        
        // √ñnceki bekleyen kaydƒ± iptal et
        if (saveTimeout) clearTimeout(saveTimeout);
        
        // Yeni bir kayƒ±t emri ver (1 saniye bekle)
        saveTimeout = setTimeout(() => {
            indicator.style.display = 'block'; // G√∂ster
            saveToCloud().then(() => {
                setTimeout(() => { indicator.style.display = 'none'; }, 1000); // 1 sn sonra gizle
            });
        }, 1000); // 1000ms bekleme s√ºresi
    }

    function saveToCloud() {
        const user = auth.currentUser;
        if(!user) return Promise.resolve();
        return saveToCloudInternal(user.uid, appData);
    }

    function saveToCloudInternal(uid, data) {
        return db.collection('users').doc(uid).set(data).catch(e => console.error(e));
    }

    // --- EVENT HANDLERS (INPUT Y√ñNETƒ∞Mƒ∞) ---
    
    // Adƒ±m sayƒ±sƒ± deƒüi≈üince
    function handleStepInput(val) {
        appData.dailySteps = parseInt(val) || 0;
        calculateStats(); // Ekrandaki hesaplarƒ± g√ºncelle (Anlƒ±k)
        triggerSave();    // Veritabanƒ±na kaydƒ± sƒ±raya al
    }

    // Profil verileri deƒüi≈üince
    function handleProfileInput(isWeight = false) {
        appData.height = parseFloat(document.getElementById('uHeight').value) || 0;
        appData.weight = parseFloat(document.getElementById('uWeight').value) || 0;
        appData.targetWeight = parseFloat(document.getElementById('uTarget').value) || 0;
        appData.weightFreq = parseInt(document.getElementById('uFreq').value) || 7;
        
        if(isWeight) {
            appData.lastWeightUpdate = new Date().toISOString().split('T')[0];
        }

        calculateStats();
        triggerSave();
    }

    // --- HESAPLAMA MOTORU ---
    function calculateStats() {
        const steps = appData.dailySteps || 0;
        const sCal = Math.round(steps * 0.04);
        
        let spCal = 0; 
        if(appData.activities) {
            appData.activities.forEach(a => { if(a.completed) spCal += a.cal; });
        }

        document.getElementById('totalCal').innerText = sCal + spCal;
        document.getElementById('stepCal').innerText = sCal;
        document.getElementById('sportCal').innerText = spCal;

        // BMI ve Bar Hesaplama
        const bmiLbl = document.getElementById('bmiLabel');
        const p = langPack[appData.lang || 'tr'];
        
        if(appData.height > 0 && appData.weight > 0) {
            const h = appData.height/100;
            const bmi = (appData.weight / (h*h)).toFixed(1);
            bmiLbl.innerText = "BMI: " + bmi;
            
            if(bmi<18.5) { bmiLbl.style.background="#74b9ff"; bmiLbl.style.color="#fff"; }
            else if(bmi<25) { bmiLbl.style.background="#00b894"; bmiLbl.style.color="#fff"; }
            else if(bmi<30) { bmiLbl.style.background="#fdcb6e"; bmiLbl.style.color="#fff"; }
            else { bmiLbl.style.background="#ff7675"; bmiLbl.style.color="#fff"; }
        } else {
            bmiLbl.innerText = "--";
            bmiLbl.style.background="#dfe6e9"; bmiLbl.style.color="#636e72";
        }

        document.getElementById('curW').innerText = appData.weight || "--";
        document.getElementById('tarW').innerText = appData.targetWeight || "--";

        if(appData.targetWeight > 0 && appData.weight > 0) {
             let progress = 0;
             // Kilo verme hedefi varsayƒ±mƒ±
             if(appData.weight > appData.targetWeight) {
                 // Basit bir g√∂rselle≈ütirme (Tam algoritma karma≈üƒ±k olabilir)
                 progress = 50; 
             } else {
                 progress = 100;
             }
             // Daha d√ºzg√ºn bir bar i√ßin sabit width verelim ≈üimdilik
             document.getElementById('wProg').style.width = "100%";
        }
    }

    // --- AKTƒ∞Vƒ∞TE & Lƒ∞STE ---
    function addNewActivity() {
        const n = document.getElementById('actName').value;
        const c = parseInt(document.getElementById('actCal').value);
        const l = document.getElementById('actLink').value;
        if(n && c) {
            if(!appData.activities) appData.activities = [];
            appData.activities.push({id:Date.now(), name:n, cal:c, link:l, completed:false});
            document.getElementById('actName').value=''; 
            document.getElementById('actCal').value='';
            document.getElementById('actLink').value='';
            
            renderTasks();
            renderManage();
            calculateStats();
            triggerSave(); // Kaydet
            alert(langPack[appData.lang].alert_added);
        }
    }

    function toggleTask(id) {
        const t = appData.activities.find(a=>a.id===id);
        if(t) { 
            t.completed = !t.completed; 
            calculateStats(); 
            triggerSave(); 
            renderTasks(); // Checkbox g√∂rselini g√ºncelle
        }
    }

    function deleteTask(id) {
        if(confirm("Silmek istediƒüine emin misin?")) {
            appData.activities = appData.activities.filter(a=>a.id!==id);
            renderTasks();
            renderManage();
            calculateStats();
            triggerSave();
        }
    }

    function renderTasks() {
        const c = document.getElementById('taskList'); c.innerHTML = '';
        if(appData.activities) {
            appData.activities.forEach(a => {
                c.innerHTML += `<div class="task-row ${a.completed?'checked':''}" onclick="toggleTask(${a.id})">
                <div class="checkbox"></div>
                <div style="flex:1;"><span>${a.name}</span> <small style="color:var(--text-sub);">(${a.cal} kcal)</small></div>
                ${a.link ? `<a href="${a.link}" target="_blank" onclick="event.stopPropagation()">üé¨</a>`:''}
                </div>`;
            });
        }
    }

    function renderManage() {
        const c = document.getElementById('manageList'); c.innerHTML='';
        if(appData.activities) appData.activities.forEach(a => c.innerHTML += `<div class="task-row" style="padding:10px;"><span>${a.name}</span> <button onclick="deleteTask(${a.id})" style="margin-left:auto;color:#ff7675;background:none;border:none;">Sil</button></div>`);
    }

    // --- G√úN SONU & GE√áMƒ∞≈û ---
    function checkNewDay() {
        const t = new Date().toLocaleDateString('tr-TR');
        if(appData.lastDate !== t) {
            endDay(true); // Otomatik bitir
            appData.lastDate = t;
            saveToCloud();
            alert(langPack[appData.lang].alert_newDay);
        }
    }

    function endDay(auto=false) {
        if(!auto && !confirm(langPack[appData.lang].endDay + "?")) return;
        
        const s = Math.round((appData.dailySteps || 0) * 0.04);
        let sp = 0; if(appData.activities) appData.activities.forEach(a => { if(a.completed) sp += a.cal; });
        
        if(s+sp > 0) {
            if(!appData.history) appData.history = [];
            appData.history.unshift({date: appData.lastDate, total: s+sp, steps: appData.dailySteps});
            
            // Sƒ±fƒ±rlama i≈ülemi
            appData.dailySteps = 0;
            if(appData.activities) appData.activities.forEach(a=>a.completed=false);
            
            fillInputsFromData(); // Inputlarƒ± da sƒ±fƒ±rla!
            calculateStats();
            saveToCloud();
            
            if(!auto) alert("G√ºn ar≈üivlendi!");
        }
    }

    function renderHistory() {
        const tb = document.querySelector('#historyTable tbody'); tb.innerHTML='';
        if(appData.history) appData.history.forEach(h => tb.innerHTML += `<tr style="border-bottom:1px solid var(--border);"><td style="padding:10px;">${h.date}</td><td>${h.steps}</td><td>${h.total}</td></tr>`);
    }

    function clearHistory() { 
        if(confirm("T√ºm ge√ßmi≈üi sil?")) { 
            appData.history=[]; 
            renderHistory(); 
            triggerSave(); 
        } 
    }

    // --- NAVƒ∞GASYON ---
    function switchPage(id, el) {
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(el) {
            document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
            el.classList.add('active');
        }
    }

    // --- AYARLAR & Dƒ∞L ---
    const langPack = {
        tr: {
            loginSub: "Hedefine ula≈ü, sƒ±nƒ±rlarƒ±nƒ± zorla.",
            emailPh: "E-posta Adresi", passPh: "≈ûifre",
            loginBtn: "Devam Et ‚Üí", regBtn: "Hesap Olu≈ütur",
            welcome_login: "Giri≈ü Yap", welcome_reg: "Kayƒ±t Ol",
            menu_home: "Ana Sayfa", menu_add: "Ekle", menu_history: "Ge√ßmi≈ü", menu_profile: "Profil", menu_logout: "√áƒ±kƒ±≈ü Yap",
            remind: "Tartƒ±lma zamanƒ± geldi!",
            bodyStat: "V√ºcut Durumu", cur: "Kilo", tar: "Hedef",
            total: "G√ºnl√ºk √ñzet", step: "ADIM", sport: "SPOR",
            todayWork: "G√∂revler", stepCount: "Hƒ±zlƒ± Adƒ±m Giri≈üi",
            addAct: "Yeni Aktivite", actNamePh: "Ad (√ñrn: Y√ºr√ºy√º≈ü)", actCalPh: "Kalori", addListBtn: "Listeye Ekle", myList: "Kayƒ±tlƒ± Aktivitelerim",
            histTitle: "Ge√ßmi≈ü Kayƒ±tlar", th_date: "Tarih", th_step: "Adƒ±m", th_cal: "Kcal", clearHist: "Temizle",
            settings: "Profil Ayarlarƒ±", lbl_height: "Boy (cm)", lbl_weight: "G√ºncel Kilo (kg)", lbl_target: "Hedef Kilo", lbl_freq: "Hatƒ±rlatma", saveBtn: "Ayarlarƒ± Kaydet",
            endDay: "G√ºn√º bitirip ar≈üive kaldƒ±rƒ±r.", archBtn: "G√ºn√º Bitir",
            alert_newDay: "‚òÄÔ∏è Yeni bir g√ºn ba≈üladƒ±! ƒ∞statistikler sƒ±fƒ±rlandƒ±.", alert_saved: "‚úÖ Kaydedildi!", alert_added: "‚úÖ Eklendi!",
            welcome_user: "Ho≈ü geldin,"
        },
        en: {
            loginSub: "Reach your goals, push your limits.",
            emailPh: "Email Address", passPh: "Password",
            loginBtn: "Continue ‚Üí", regBtn: "Create Account",
            welcome_login: "Login", welcome_reg: "Register",
            menu_home: "Home", menu_add: "Add", menu_history: "History", menu_profile: "Profile", menu_logout: "Logout",
            remind: "Time to weigh in!",
            bodyStat: "Body Status", cur: "Weight", tar: "Target",
            total: "Daily Summary", step: "STEPS", sport: "SPORT",
            todayWork: "Today's Tasks", stepCount: "Step Entry",
            addAct: "New Activity", actNamePh: "Name (e.g. Run)", actCalPh: "Calories", addListBtn: "Add to List", myList: "My Activities",
            histTitle: "History Logs", th_date: "Date", th_step: "Steps", th_cal: "Kcal", clearHist: "Clear",
            settings: "Profile Settings", lbl_height: "Height (cm)", lbl_weight: "Current Weight (kg)", lbl_target: "Target Weight", lbl_freq: "Reminder Freq", saveBtn: "Save Settings",
            endDay: "Archive stats and end day.", archBtn: "End Day",
            alert_newDay: "‚òÄÔ∏è A new day has started! Stats reset.", alert_saved: "‚úÖ Saved!", alert_added: "‚úÖ Added!",
            welcome_user: "Welcome,"
        }
    };

    function toggleLang() {
        const c = appData.lang || 'tr';
        const n = c === 'tr' ? 'en' : 'tr';
        appData.lang = n;
        localStorage.setItem('localLang', n);
        applySettingsToDOM(n, appData.theme);
        triggerSave();
    }

    function toggleThemeGlobal() {
        const c = appData.theme || 'light';
        const n = c === 'light' ? 'dark' : 'light';
        appData.theme = n;
        localStorage.setItem('localTheme', n);
        applySettingsToDOM(appData.lang, n);
        triggerSave();
    }

    function applySettingsToDOM(l, th) {
        document.documentElement.setAttribute('data-theme', th);
        const p = langPack[l];
        // Basit text g√ºncellemeleri
        document.getElementById('txt_welcome').innerText = p.welcome_user;
        document.getElementById('langBtnLogin').innerText = l.toUpperCase();
        document.getElementById('langBtnApp').innerText = l.toUpperCase();
        document.getElementById('themeBtnLogin').innerText = th==='light'?'‚òÄ':'üåô';
        document.getElementById('themeBtnApp').innerText = th==='light'?'‚òÄ':'üåô';
        document.getElementById('txt_loginSub').innerText = p.loginSub;
        document.getElementById('email').placeholder = p.emailPh; document.getElementById('password').placeholder = p.passPh;
        document.getElementById('btn_welcome_login').innerText = p.welcome_login; document.getElementById('btn_welcome_reg').innerText = p.welcome_reg;
        document.getElementById('menu_home').innerText = p.menu_home; document.getElementById('menu_add').innerText = p.menu_add;
        document.getElementById('menu_history').innerText = p.menu_history; document.getElementById('menu_profile').innerText = p.menu_profile;
        document.getElementById('menu_logout').innerText = p.menu_logout;
        document.getElementById('txt_remind').innerText = p.remind; document.getElementById('txt_bodyStat').innerText = p.bodyStat;
        document.getElementById('txt_cur').innerText = p.cur; document.getElementById('txt_tar').innerText = p.tar;
        document.getElementById('txt_total').innerText = p.total; document.getElementById('txt_step').innerText = p.step; document.getElementById('txt_sport').innerText = p.sport;
        document.getElementById('txt_todayWork').innerText = p.todayWork; document.getElementById('txt_stepCount').innerText = p.stepCount;
        document.getElementById('txt_addAct').innerText = p.addAct; document.getElementById('actName').placeholder = p.actNamePh; document.getElementById('actCal').placeholder = p.actCalPh;
        document.getElementById('btn_addList').innerText = p.addListBtn; document.getElementById('txt_myList').innerText = p.myList;
        document.getElementById('txt_histTitle').innerText = p.histTitle; document.getElementById('th_date').innerText = p.th_date; document.getElementById('th_step').innerText = p.th_step; document.getElementById('th_cal').innerText = p.th_cal; document.getElementById('btn_clearHist').innerText = p.clearHist;
        document.getElementById('txt_settings').innerText = p.settings; document.getElementById('lbl_height').innerText = p.lbl_height; document.getElementById('lbl_weight').innerText = p.lbl_weight; document.getElementById('lbl_target').innerText = p.lbl_target; document.getElementById('lbl_freq').innerText = p.lbl_freq;
        document.getElementById('txt_endDay').innerText = p.endDay; document.getElementById('btn_archive').innerText = p.archBtn;
    }
</script>
</body>
</html>
