<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FitTakip Cloud Pro</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        /* TASARIM AYARLARI */
        :root {
            --primary: #6c5ce7;
            --bg: #f5f6fa;
            --surface: #ffffff;
            --text: #2d3436;
        }

        body { font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; }
        * { box-sizing: border-box; }

        /* Gƒ∞Rƒ∞≈û EKRANI */
        #loginScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .login-box {
            background: var(--surface); padding: 30px; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 90%; max-width: 400px; text-align: center;
        }
        input {
            width: 100%; padding: 15px; margin-bottom: 10px; border-radius: 10px;
            border: 1px solid #ddd; font-family: inherit;
        }
        .btn-main {
            width: 100%; padding: 15px; background: var(--primary); color: white;
            border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px;
        }

        /* ANA EKRAN */
        #appScreen { display: none; padding: 20px; max-width: 600px; margin: 0 auto; }
        
        .card {
            background: var(--surface); padding: 20px; border-radius: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 20px;
        }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; text-align: center; }
        .stat-val { font-size: 24px; font-weight: bold; color: var(--primary); display: block; }
        
        /* SYNC DURUMU */
        #syncStatus {
            position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
            background: #00b894; color: white; padding: 5px 15px; border-radius: 20px;
            font-size: 12px; font-weight: bold; opacity: 0; transition: 0.3s; pointer-events: none;
        }

        /* MENU */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 70px;
            background: var(--surface); display: flex; justify-content: space-around; align-items: center;
            border-top-left-radius: 20px; border-top-right-radius: 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
        }
        .nav-btn { background: none; border: none; font-size: 24px; cursor: pointer; opacity: 0.5; }
        .nav-btn.active { opacity: 1; color: var(--primary); }

        .page { display: none; }
        .page.active { display: block; }
        
        .task-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; }
        .checked { text-decoration: line-through; color: #b2bec3; }
    </style>
</head>
<body>

    <div id="syncStatus">‚òÅÔ∏è Buluta Kaydedildi</div>

    <div id="loginScreen">
        <div class="login-box">
            <h1>FitTakip Cloud</h1>
            <p>Verilerin e-postana baƒülanƒ±r.</p>
            <input type="email" id="email" placeholder="E-posta">
            <input type="password" id="pass" placeholder="≈ûifre">
            <button class="btn-main" onclick="authAction('login')">Giri≈ü Yap</button>
            <button class="btn-main" style="background:#b2bec3; margin-top:10px;" onclick="authAction('register')">Kayƒ±t Ol</button>
            <p id="authError" style="color:red; font-size:12px; margin-top:10px;"></p>
        </div>
    </div>

    <div id="appScreen">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 id="userTitle">Ho≈ügeldin</h2>
            <button onclick="logout()" style="background:none; border:1px solid red; color:red; padding:5px 10px; border-radius:5px;">√áƒ±kƒ±≈ü</button>
        </div>

        <div id="page-home" class="page active">
            <div class="card">
                <div class="stat-grid">
                    <div><span class="stat-val" id="dispTotal">0</span><small>TOPLAM</small></div>
                    <div><span class="stat-val" id="dispStep">0</span><small>ADIM</small></div>
                    <div><span class="stat-val" id="dispSport">0</span><small>SPOR</small></div>
                </div>
            </div>

            <div class="card">
                <h3>üëü Bug√ºn Ka√ß Adƒ±m?</h3>
                <input type="number" id="inpStep" placeholder="0" oninput="handleStepChange(this.value)" style="font-size:20px; text-align:center;">
                <small style="color:#636e72;">Yazdƒ±ƒüƒ±n an buluta kaydedilir.</small>
            </div>

            <div class="card">
                <h3>üî• Aktiviteler</h3>
                <div id="taskList"></div>
                <div style="margin-top:10px; display:flex; gap:5px;">
                    <input type="text" id="newActName" placeholder="√ñrn: Mekik" style="margin:0;">
                    <input type="number" id="newActCal" placeholder="Kcal" style="width:80px; margin:0;">
                    <button onclick="addActivity()" style="background:var(--primary); color:white; border:none; border-radius:10px; padding:0 15px;">+</button>
                </div>
            </div>
        </div>

        <div id="page-history" class="page">
            <div class="card">
                <h3>üìú Ge√ßmi≈ü Kayƒ±tlar</h3>
                <button onclick="endDay()" class="btn-main" style="background:#fdcb6e; color:#2d3436; margin-bottom:15px;">G√ºn√º Bitir & Ar≈üivle</button>
                <div id="historyList"></div>
            </div>
        </div>

    </div>

    <div class="bottom-nav" id="navBar" style="display:none;">
        <button class="nav-btn active" onclick="switchPage('home')">üè†</button>
        <button class="nav-btn" onclick="switchPage('history')">üìÖ</button>
    </div>

<script>
    // --- 1. AYARLAR ---
    const firebaseConfig = {
      apiKey: "AIzaSyB656zs8jf-Pib4nDGjzm81EDYsK8WL-Xc",
      authDomain: "fittakipp.firebaseapp.com",
      projectId: "fittakipp",
      storageBucket: "fittakipp.firebasestorage.app",
      messagingSenderId: "526085600537",
      appId: "1:526085600537:web:d56687929540fd932f4188"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let data = {
        dailySteps: 0,
        activities: [],
        history: [],
        lastDate: new Date().toLocaleDateString('tr-TR')
    };

    let saveTimer = null; // Yazarken s√ºrekli kaydetmesin, bitince kaydetsin (Debounce)

    // --- 2. Gƒ∞Rƒ∞≈û KONTROL√ú ---
    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appScreen').style.display = 'block';
            document.getElementById('navBar').style.display = 'flex';
            document.getElementById('userTitle').innerText = user.email.split('@')[0];
            loadData(); // Giri≈ü yapƒ±nca veriyi √ßek
        } else {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('appScreen').style.display = 'none';
            document.getElementById('navBar').style.display = 'none';
        }
    });

    function authAction(type) {
        const e = document.getElementById('email').value;
        const p = document.getElementById('pass').value;
        const err = document.getElementById('authError');
        
        if(type === 'login') {
            auth.signInWithEmailAndPassword(e, p).catch(e => err.innerText = e.message);
        } else {
            auth.createUserWithEmailAndPassword(e, p).then(() => {
                saveData(true); // Yeni kullanƒ±cƒ± i√ßin bo≈ü veri olu≈ütur
            }).catch(e => err.innerText = e.message);
        }
    }

    function logout() { auth.signOut(); location.reload(); }

    // --- 3. VERƒ∞TABANI ƒ∞≈ûLEMLERƒ∞ (EN √ñNEMLƒ∞ KISIM) ---
    
    // VERƒ∞ √áEKME
    function loadData() {
        if(!currentUser) return;
        
        // Veritabanƒ±ndan kullanƒ±cƒ±nƒ±n verisini al
        db.collection('users').doc(currentUser.uid).get().then(doc => {
            if (doc.exists) {
                // Veri varsa deƒüi≈ükene ata
                const cloudData = doc.data();
                data = { ...data, ...cloudData }; // Eksikleri tamamla
                
                // G√ºn√º kontrol et
                const today = new Date().toLocaleDateString('tr-TR');
                if (data.lastDate !== today) {
                    alert("Yeni g√ºn ba≈üladƒ±! Saya√ßlar sƒ±fƒ±rlanƒ±yor...");
                    archiveOldDay(); // Eski g√ºn√º kaydet
                }

                updateUI(); // Ekranƒ± g√ºncelle
            } else {
                saveData(true); // Veri yoksa olu≈ütur
            }
        });
    }

    // VERƒ∞ KAYDETME
    function saveData(force = false) {
        if(!currentUser) return;

        // Ekrana "Kaydediliyor" yaz
        const status = document.getElementById('syncStatus');
        status.style.opacity = '1';
        status.innerText = "‚òÅÔ∏è Kaydediliyor...";
        status.style.background = "#fdcb6e"; // Sarƒ±

        // Veritabanƒ±na G√ñNDER
        db.collection('users').doc(currentUser.uid).set(data)
            .then(() => {
                // Ba≈üarƒ±lƒ± olunca
                setTimeout(() => {
                    status.innerText = "‚úÖ Buluta Kaydedildi";
                    status.style.background = "#00b894"; // Ye≈üil
                    setTimeout(() => status.style.opacity = '0', 2000);
                }, 500);
            })
            .catch((error) => {
                status.innerText = "‚ùå Hata!";
                status.style.background = "#ff7675";
                console.error("Kayƒ±t hatasƒ±: ", error);
            });
    }

    // --- 4. HESAPLAMALAR VE ARAY√úZ ---
    
    // Adƒ±m sayƒ±sƒ± deƒüi≈üince
    function handleStepChange(val) {
        data.dailySteps = parseInt(val) || 0;
        calculate();
        
        // Yazarken bekle, yazma bitince kaydet (1 saniye bekleme)
        clearTimeout(saveTimer);
        saveTimer = setTimeout(() => {
            saveData();
        }, 1000);
    }

    function calculate() {
        const stepCal = Math.round(data.dailySteps * 0.04);
        let sportCal = 0;
        data.activities.forEach(a => { if(a.done) sportCal += a.cal; });

        document.getElementById('dispStep').innerText = stepCal;
        document.getElementById('dispSport').innerText = sportCal;
        document.getElementById('dispTotal').innerText = stepCal + sportCal;
    }

    function updateUI() {
        // Inputlarƒ± doldur
        document.getElementById('inpStep').value = data.dailySteps === 0 ? '' : data.dailySteps;
        
        // Listeyi doldur
        const list = document.getElementById('taskList');
        list.innerHTML = '';
        data.activities.forEach((act, index) => {
            list.innerHTML += `
            <div class="task-item" onclick="toggleTask(${index})">
                <span class="${act.done ? 'checked' : ''}">${act.name} (${act.cal} kcal)</span>
                <span>${act.done ? '‚úÖ' : '‚¨ú'}</span>
                <span onclick="delTask(${index}, event)" style="color:red; margin-left:10px;">üóëÔ∏è</span>
            </div>`;
        });

        // Ge√ßmi≈üi doldur
        const hist = document.getElementById('historyList');
        hist.innerHTML = '';
        data.history.forEach(h => {
            hist.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee;">
                <b>${h.date}</b>: ${h.total} kcal (${h.steps} adƒ±m)
            </div>`;
        });

        calculate();
    }

    // --- 5. AKTƒ∞Vƒ∞TE Y√ñNETƒ∞Mƒ∞ ---
    function addActivity() {
        const name = document.getElementById('newActName').value;
        const cal = parseInt(document.getElementById('newActCal').value);
        if(name && cal) {
            data.activities.push({ name: name, cal: cal, done: false });
            document.getElementById('newActName').value = '';
            document.getElementById('newActCal').value = '';
            updateUI();
            saveData(); // Anƒ±nda kaydet
        }
    }

    function toggleTask(index) {
        data.activities[index].done = !data.activities[index].done;
        updateUI();
        saveData();
    }

    function delTask(index, e) {
        e.stopPropagation(); // Tƒ±klamayƒ± engelle
        data.activities.splice(index, 1);
        updateUI();
        saveData();
    }

    // --- 6. G√úN Bƒ∞Tƒ∞RME ---
    function endDay() {
        if(!confirm("G√ºn√º bitirip ar≈üive atmak istiyor musun?")) return;
        archiveOldDay();
    }

    function archiveOldDay() {
        const sCal = Math.round(data.dailySteps * 0.04);
        let spCal = 0;
        data.activities.forEach(a => { if(a.done) spCal += a.cal; });

        if(sCal + spCal > 0) {
            data.history.unshift({
                date: data.lastDate,
                total: sCal + spCal,
                steps: data.dailySteps
            });
        }
        
        // Sƒ±fƒ±rla
        data.dailySteps = 0;
        data.activities.forEach(a => a.done = false);
        data.lastDate = new Date().toLocaleDateString('tr-TR');
        
        updateUI();
        saveData();
    }

    function switchPage(p) {
        document.querySelectorAll('.page').forEach(e => e.classList.remove('active'));
        document.getElementById('page-'+p).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }
</script>
</body>
</html>
