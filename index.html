<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FitTakip</title>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        /* --- CSS DEƒûƒ∞≈ûKENLERƒ∞ (Tema Ayarlarƒ±) --- */
        :root { --primary: #007bff; --bg: #f4f7f6; --text: #333; --card-bg: #ffffff; --input-bg: #ffffff; --border: #ddd; --header-bg: #ffffff; }
        [data-theme="dark"] { --primary: #37a0f4; --bg: #121212; --text: #e0e0e0; --card-bg: #1e1e1e; --input-bg: #2d2d2d; --border: #444; --header-bg: #1e1e1e; }

        body { font-family: -apple-system, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; transition: background-color 0.3s, color 0.3s; }

        /* BUTONLAR & KONTROLLER (Saƒü √úst) */
        .top-controls {
            position: absolute; top: 15px; right: 15px; z-index: 1000;
            display: flex; gap: 10px;
        }
        .header-controls {
            display: flex; gap: 8px; margin-left: auto;
        }
        .icon-btn {
            background: rgba(128,128,128,0.15); border: 1px solid var(--border); cursor: pointer;
            font-size: 16px; font-weight: bold; padding: 0; border-radius: 8px; width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center; transition: 0.2s; color: var(--text);
        }
        .icon-btn:hover { background: rgba(128,128,128,0.3); }

        /* Gƒ∞Rƒ∞≈û EKRANI */
        #loginPage {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; padding: 20px; text-align: center; position: relative;
        }
        .login-card {
            background: var(--card-bg); padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            width: 100%; max-width: 350px;
            transition: 0.3s;
        }
        .login-card h1 { margin-bottom: 5px; color: var(--text); }
        .login-card h2 { margin-top: 0; color: var(--primary); }
        
        /* Gƒ∞ZLENEBƒ∞Lƒ∞R ALANLAR */
        #auth-forms { display: none; margin-top: 20px; }
        #welcome-buttons { display: flex; flex-direction: column; gap: 15px; margin-top: 30px; width: 100%; }
        
        .login-card input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid var(--border); border-radius: 8px; background: var(--input-bg); color: var(--text); box-sizing: border-box; }
        
        button.primary-btn { width: 100%; background-color: var(--primary); color: white; padding: 14px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        button.secondary-btn { width: 100%; background-color: transparent; border: 1px solid var(--border); color: var(--text); padding: 14px; border-radius: 8px; font-size: 16px; cursor: pointer; font-weight: bold; }
        button.text-btn { background: none; border: none; color: var(--text); opacity: 0.7; cursor: pointer; margin-top: 10px; text-decoration: underline; font-size: 14px; }
        button.danger-btn { background-color: #dc3545; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; margin-top: 5px; font-size: 13px; width: 100%; }

        /* UYGULAMA ƒ∞√áƒ∞ */
        #appPage { display: none; }

        /* HEADER & MEN√ú */
        header { 
            background: var(--header-bg); padding: 10px 15px; display: flex; align-items: center; 
            position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
            height: 50px;
        }
        .menu-btn { font-size: 24px; cursor: pointer; margin-right: 15px; background: none; border: none; color: var(--text); }
        .app-title { font-weight: bold; font-size: 18px; color: var(--primary); margin: 0; }
        
        .sidebar { height: 100%; width: 260px; position: fixed; z-index: 200; top: 0; left: -270px; background-color: #343a40; transition: 0.3s; padding-top: 60px; }
        .sidebar a { padding: 15px 25px; text-decoration: none; color: #f1f1f1; display: block; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .closebtn { position: absolute; top: 10px; right: 20px; font-size: 30px; color: white; background: none; border: none; cursor: pointer; }
        .overlay { display: none; position: fixed; width: 100%; height: 100%; top: 0; left: 0; background: rgba(0,0,0,0.5); z-index: 150; }
        
        /* SAYFALAR & KARTLAR */
        .page { display: none; padding: 20px; max-width: 600px; margin: 0 auto; }
        .page.active { display: block; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: 0.3s; }
        
        /* WIDGETLAR */
        .bmi-box { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.03); padding: 15px; border-radius: 8px; border: 1px solid var(--border); }
        .task-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid var(--border); }
        .progress-bar { height: 10px; background: var(--border); border-radius: 5px; overflow: hidden; margin-top: 5px; }
        .progress-fill { height: 100%; background: #28a745; width: 0%; transition: width 0.5s; }
        .error-msg { color: #dc3545; font-size: 14px; margin-top: 10px; display: none; border: 1px solid #dc3545; padding: 10px; border-radius: 5px; background: rgba(220, 53, 69, 0.1); }
    </style>
</head>
<body>

    <div id="loginPage">
        <div class="top-controls">
            <button class="icon-btn" onclick="toggleLang()" id="langBtnLogin">TR</button>
            <button class="icon-btn" onclick="toggleThemeGlobal()" id="themeBtnLogin">‚òÄ</button>
        </div>

        <div class="login-card">
            <h1>FitTakip ‚òÅÔ∏è</h1>
            <p id="txt_loginSub">Verilerin artƒ±k bulutta saklanƒ±yor.</p>
            
            <div id="welcome-buttons">
                <button class="primary-btn" onclick="showForm('login')" id="btn_welcome_login">Giri≈ü Yap</button>
                <button class="secondary-btn" onclick="showForm('register')" id="btn_welcome_reg">Kayƒ±t Ol</button>
            </div>

            <div id="auth-forms">
                <h2 id="form-title">Giri≈ü</h2>
                <input type="email" id="email" placeholder="E-posta Adresi">
                <input type="password" id="password" placeholder="≈ûifre">
                
                <div id="loginError" class="error-msg"></div>
                <button id="resendBtn" class="danger-btn" style="display:none;" onclick="resendVerification()">üì© Doƒürulama Mailini Tekrar G√∂nder</button>

                <button class="primary-btn" id="btn_action" onclick="performAuth()">Giri≈ü Yap</button>
                <button class="text-btn" onclick="goBack()" id="btn_back">‚Üê Geri D√∂n</button>
            </div>

            <div style="margin-top:20px; font-size:12px; opacity:0.6;">FitTakip Global v9.0</div>
        </div>
    </div>

    <div id="appPage">
        <div id="overlay" class="overlay" onclick="closeNav()"></div>

        <div id="mySidebar" class="sidebar">
            <button class="closebtn" onclick="closeNav()">&times;</button>
            <div style="text-align:center; padding: 20px; opacity:0.6; font-size: 12px;" id="txt_userTitle">KULLANICI</div>
            <div style="text-align:center; padding-bottom: 20px; font-weight:bold; color:var(--primary);" id="userEmailDisplay">...</div>

            <a href="#" onclick="switchPage('dashboard')">üè† <span id="menu_home">Ana Sayfa</span></a>
            <a href="#" onclick="switchPage('add-activity')">‚ûï <span id="menu_add">Aktivite Ekle</span></a>
            <a href="#" onclick="switchPage('history')">üìú <span id="menu_history">Ge√ßmi≈ü</span></a>
            <a href="#" onclick="switchPage('profile')">üë§ <span id="menu_profile">Ayarlar</span></a>
            <a href="#" onclick="cikisYap()" style="color:#dc3545; border-top:1px solid #555; margin-top:20px;">üö™ <span id="menu_logout">√áƒ±kƒ±≈ü Yap</span></a>
        </div>

        <header>
            <button class="menu-btn" onclick="openNav()">&#9776;</button>
            <p class="app-title">FitTakip</p>
            <div class="header-controls">
                <button class="icon-btn" onclick="toggleLang()" id="langBtnApp">TR</button>
                <button class="icon-btn" onclick="toggleThemeGlobal()" id="themeBtnApp">‚òÄ</button>
            </div>
        </header>

        <div id="dashboard" class="page active">
            <div id="weightReminder" class="card" style="background:#fff3cd; color:#856404; display:none; text-align:center; cursor:pointer;" onclick="switchPage('profile')">‚ö†Ô∏è <span id="txt_remind">Tartƒ±lma zamanƒ±!</span></div>
            
            <div class="card">
                <h2 id="txt_bodyStat">V√ºcut Durumu</h2>
                <div class="bmi-box">
                    <div><small>BMI</small><br><strong id="bmiValue" style="font-size:24px; color:var(--primary);">--</strong></div>
                    <div id="bmiLabel" style="padding:4px 8px; border-radius:4px; font-size:12px; color:white; background:#ccc;">--</div>
                </div>
                <div style="margin-top:10px;">
                    <small><span id="txt_cur">Mevcut</span>: <b id="curW">--</b> | <span id="txt_tar">Hedef</span>: <b id="tarW">--</b></small>
                    <div class="progress-bar"><div id="wProg" class="progress-fill"></div></div>
                </div>
            </div>

            <div class="card" style="text-align:center;">
                <div style="display:flex; justify-content:space-around;">
                    <div><strong id="totalCal" style="font-size:20px; color:var(--primary);">0</strong><br><small id="txt_total">Toplam</small></div>
                    <div><strong id="stepCal" style="font-size:20px; opacity:0.6;">0</strong><br><small id="txt_step">Adƒ±m</small></div>
                    <div><strong id="sportCal" style="font-size:20px; opacity:0.6;">0</strong><br><small id="txt_sport">Spor</small></div>
                </div>
            </div>

            <div class="card">
                <h2 id="txt_todayWork">Bug√ºnk√º Antrenmanlar</h2>
                <div id="taskList"></div>
            </div>

            <div class="card">
                <h2 id="txt_stepCount">Adƒ±m Sayacƒ±</h2>
                <input type="number" id="dailySteps" placeholder="0" oninput="calculate()">
            </div>
        </div>

        <div id="add-activity" class="page">
            <div class="card">
                <h2 id="txt_addAct">Aktivite Ekle</h2>
                <input type="text" id="actName" placeholder="...">
                <input type="url" id="actLink" placeholder="YouTube Link (Opsiyonel)">
                <input type="number" id="actCal" placeholder="Kalori (kcal)">
                <button class="primary-btn" onclick="addNewActivity()" id="btn_addList">Listeme Ekle</button>
            </div>
            <div class="card">
                <h2 id="txt_myList">Listem</h2>
                <div id="manageList"></div>
            </div>
        </div>

        <div id="history" class="page">
            <div class="card">
                <h2 id="txt_histTitle">Ge√ßmi≈ü</h2>
                <table width="100%" id="historyTable" style="text-align:left;">
                    <thead><th id="th_date">Tarih</th><th id="th_step">Adƒ±m</th><th id="th_cal">Kcal</th></thead>
                    <tbody></tbody>
                </table>
                <button class="primary-btn" style="background:#6c757d; margin-top:20px;" onclick="clearHistory()" id="btn_clearHist">Ge√ßmi≈üi Sil</button>
            </div>
        </div>

        <div id="profile" class="page">
            <div class="card">
                <h2 id="txt_settings">Ayarlar</h2>
                <label id="lbl_height">Boy (cm)</label><input type="number" id="uHeight" onchange="calculate()">
                <label id="lbl_weight">Kilo (kg)</label><input type="number" id="uWeight" onchange="updateWeightDate()">
                <label id="lbl_target">Hedef Kilo</label><input type="number" id="uTarget" onchange="saveToCloud()">
                <label id="lbl_freq">Hatƒ±rlatma Sƒ±klƒ±ƒüƒ±</label>
                <select id="uFreq" onchange="saveToCloud()">
                    <option value="7">7 G√ºn</option>
                    <option value="30">30 G√ºn</option>
                </select>
                <button class="primary-btn" onclick="saveToCloud(); alert(t('saved'));" id="btn_save">Kaydet</button>
            </div>
            <div class="card">
                <h2 id="txt_endDay">G√ºn√º Bitir</h2>
                <button class="primary-btn" style="background:#ff9800;" onclick="endDay()" id="btn_archive">G√ºn√º Ar≈üivle</button>
            </div>
        </div>
    </div>

<script>
    // --- FIREBASE AYARLARI ---
    const firebaseConfig = {
      apiKey: "AIzaSyB656zs8jf-Pib4nDGjzm81EDYsK8WL-Xc",
      authDomain: "fittakipp.firebaseapp.com",
      projectId: "fittakipp",
      storageBucket: "fittakipp.firebasestorage.app",
      messagingSenderId: "526085600537",
      appId: "1:526085600537:web:d56687929540fd932f4188",
      measurementId: "G-81YYJKDC4R"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- Dƒ∞L PAKETƒ∞ (TR/EN) ---
    const langPack = {
        tr: {
            loginSub: "Verilerin artƒ±k bulutta saklanƒ±yor.",
            emailPh: "E-posta Adresi",
            passPh: "≈ûifre",
            loginBtn: "Giri≈ü Yap",
            regBtn: "Kayƒ±t Ol",
            backBtn: "‚Üê Geri D√∂n",
            welcome_login: "Giri≈ü Yap",
            welcome_reg: "Kayƒ±t Ol",
            
            menu_home: "Ana Sayfa", menu_add: "Aktivite Ekle", menu_history: "Ge√ßmi≈ü", menu_profile: "Ayarlar", menu_logout: "√áƒ±kƒ±≈ü Yap",
            remind: "‚ö†Ô∏è Tartƒ±lma zamanƒ±!",
            bodyStat: "V√ºcut Durumu", cur: "Mevcut", tar: "Hedef",
            total: "Toplam", step: "Adƒ±m", sport: "Spor",
            todayWork: "Bug√ºnk√º Antrenmanlar", stepCount: "Adƒ±m Sayacƒ±",
            addAct: "Aktivite Ekle", actNamePh: "Ad (√ñrn: Y√ºr√ºy√º≈ü)", actCalPh: "Kalori", addListBtn: "Listeme Ekle", myList: "Listem",
            histTitle: "Ge√ßmi≈ü", th_date: "Tarih", th_step: "Adƒ±m", th_cal: "Kcal", clearHist: "Ge√ßmi≈üi Sil",
            settings: "Ayarlar", lbl_height: "Boy (cm)", lbl_weight: "Kilo (kg)", lbl_target: "Hedef Kilo", lbl_freq: "Hatƒ±rlatma Sƒ±klƒ±ƒüƒ±", saveBtn: "Kaydet",
            endDay: "G√ºn√º Bitir", archBtn: "G√ºn√º Ar≈üivle",
            
            alert_newDay: "Yeni bir g√ºn ba≈üladƒ±!", alert_saved: "Kaydedildi!", alert_added: "Eklendi!",
            alert_mail_sent: "‚úÖ Doƒürulama maili g√∂nderildi!\n\n‚ö†Ô∏è L√ºtfen SPAM (Gereksiz) klas√∂r√ºn√º mutlaka kontrol et.",
            alert_verify_first: "E-posta adresin hen√ºz doƒürulanmamƒ±≈ü. L√ºtfen mailindeki linke tƒ±kla.",
            spam_check: "Spam kutusunu kontrol etmeyi unutma!",
            lbl_normal: "Normal", lbl_over: "Fazla", lbl_obese: "Obez", lbl_weak: "Zayƒ±f"
        },
        en: {
            loginSub: "Your data is now stored in the cloud.",
            emailPh: "Email Address",
            passPh: "Password",
            loginBtn: "Login",
            regBtn: "Register",
            backBtn: "‚Üê Back",
            welcome_login: "Login",
            welcome_reg: "Register",

            menu_home: "Dashboard", menu_add: "Add Activity", menu_history: "History", menu_profile: "Settings", menu_logout: "Logout",
            remind: "‚ö†Ô∏è Time to weigh in!",
            bodyStat: "Body Stats", cur: "Current", tar: "Target",
            total: "Total", step: "Steps", sport: "Sport",
            todayWork: "Today's Workouts", stepCount: "Step Counter",
            addAct: "Add Activity", actNamePh: "Name (e.g. Walking)", actCalPh: "Calories", addListBtn: "Add to List", myList: "My List",
            histTitle: "History", th_date: "Date", th_step: "Steps", th_cal: "Kcal", clearHist: "Clear History",
            settings: "Settings", lbl_height: "Height (cm)", lbl_weight: "Weight (kg)", lbl_target: "Target Weight", lbl_freq: "Reminder Freq", saveBtn: "Save",
            endDay: "End Day", archBtn: "Archive Day",
            
            alert_newDay: "A new day has started!", alert_saved: "Saved!", alert_added: "Added!",
            alert_mail_sent: "‚úÖ Verification email sent!\n\n‚ö†Ô∏è Please check your SPAM/Junk folder.",
            alert_verify_first: "Your email is not verified yet. Please click the link in your email.",
            spam_check: "Don't forget to check your spam folder!",
            lbl_normal: "Normal", lbl_over: "Overweight", lbl_obese: "Obese", lbl_weak: "Underweight"
        }
    };

    // --- VARSAYILAN VERƒ∞ ---
    const defaultData = {
        activities: [], history: [],
        weight: 0, height: 0, targetWeight: 0, weightFreq: 7, lastWeightUpdate: null,
        dailySteps: 0, lastDate: new Date().toLocaleDateString('tr-TR'), 
        theme: 'light', lang: 'tr'
    };

    let appData = JSON.parse(JSON.stringify(defaultData));
    let localLang = localStorage.getItem('localLang') || 'tr';
    let localTheme = localStorage.getItem('localTheme') || 'light';
    let authMode = 'login'; 

    window.onload = function() {
        applySettingsToDOM(localLang, localTheme);
    };

    // --- ARAY√úZ Y√ñNETƒ∞Mƒ∞ ---
    function showForm(mode) {
        authMode = mode;
        const p = langPack[localLang];
        document.getElementById('form-title').innerText = (mode === 'login') ? p.welcome_login : p.welcome_reg;
        document.getElementById('btn_action').innerText = (mode === 'login') ? p.loginBtn : p.regBtn;
        
        document.getElementById('welcome-buttons').style.display = 'none';
        document.getElementById('auth-forms').style.display = 'block';
        
        // Hata mesajlarƒ±nƒ± temizle
        document.getElementById('loginError').style.display = 'none';
        document.getElementById('resendBtn').style.display = 'none';
    }

    function goBack() {
        document.getElementById('auth-forms').style.display = 'none';
        document.getElementById('welcome-buttons').style.display = 'flex';
        document.getElementById('loginError').style.display = 'none';
        document.getElementById('resendBtn').style.display = 'none';
        document.getElementById('password').value = '';
    }

    function performAuth() {
        if(authMode === 'login') girisYap();
        else kayitOl();
    }

    // --- OTURUM Y√ñNETƒ∞Mƒ∞ (Kƒ∞Lƒ∞T NOKTA) ---
    // Bu kod otomatik giri≈ü i√ßindir. Kullanƒ±cƒ± mailden d√∂nerse √ßalƒ±≈üƒ±r.
    auth.onAuthStateChanged(user => {
        if (user && user.emailVerified) {
            // Mail Onaylƒ± -> ƒ∞√ßeri Al
            enterApp(user);
        } else if (user && !user.emailVerified) {
            // Giri≈ü yapmƒ±≈ü ama onaylamamƒ±≈ü -> Dƒ±≈üarƒ± atma, sadece formda hata g√∂ster
            // (Manuel girisYap fonksiyonu bunu y√∂netecek, burasƒ± sessiz kalabilir)
        } else {
            // √áƒ±kƒ±≈ü yapmƒ±≈ü
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('appPage').style.display = 'none';
        }
    });

    async function girisYap() {
        const e = document.getElementById('email').value;
        const p = document.getElementById('password').value;
        const errBox = document.getElementById('loginError');
        const resendBtn = document.getElementById('resendBtn');

        try {
            const userCredential = await auth.signInWithEmailAndPassword(e, p);
            const user = userCredential.user;

            // √ñNEMLƒ∞: Kullanƒ±cƒ± linke tƒ±kladƒ± mƒ± diye Firebase'i zorla g√ºncelle
            await user.reload();

            if (user.emailVerified) {
                // Ba≈üarƒ±lƒ±
                enterApp(user);
            } else {
                // Hata G√∂ster
                errBox.style.display = 'block';
                errBox.innerHTML = langPack[localLang].alert_verify_first;
                resendBtn.style.display = 'block'; // Tekrar g√∂nder butonu a√ß
            }
        } catch (err) {
            showError(err.message);
        }
    }

    function resendVerification() {
        const user = auth.currentUser;
        if(user) {
            user.sendEmailVerification().then(() => {
                alert(langPack[localLang].alert_mail_sent);
            }).catch(err => alert("Hata: " + err.message));
        }
    }

    function enterApp(user) {
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('appPage').style.display = 'block';
        document.getElementById('userEmailDisplay').innerText = user.email;
        loadFromCloud(user.uid);
    }

    function kayitOl() {
        const e = document.getElementById('email').value;
        const p = document.getElementById('password').value;
        appData = JSON.parse(JSON.stringify(defaultData)); 
        appData.lang = localLang;
        appData.theme = localTheme;

        auth.createUserWithEmailAndPassword(e, p).then((cred) => {
            saveToCloud(cred.user.uid); // ID ile kaydet
            cred.user.sendEmailVerification().then(() => {
                alert(langPack[localLang].alert_mail_sent);
                // Kayƒ±ttan sonra giri≈ü ekranƒ±na at, otomatik giri≈ü yapma
                auth.signOut();
                goBack(); 
            });
        }).catch(err => showError(err.message));
    }

    function cikisYap() { 
        auth.signOut().then(() => {
            location.reload(); 
        });
    }

    function showError(msg) { 
        const errBox = document.getElementById('loginError');
        errBox.style.display = 'block';
        
        if (msg.includes('email-already-in-use')) {
            errBox.innerHTML = "‚ö†Ô∏è <b>Bu e-posta zaten kayƒ±tlƒ±!</b><br>L√ºtfen 'Kayƒ±t Ol' yerine 'Giri≈ü Yap'ƒ± kullan.";
        } else if (msg.includes('wrong-password')) {
            errBox.innerText = "Hatalƒ± ≈üifre.";
        } else if (msg.includes('user-not-found')) {
            errBox.innerText = "B√∂yle bir kullanƒ±cƒ± yok.";
        } else if (msg.includes('invalid-email')) {
            errBox.innerText = "Ge√ßersiz e-posta formatƒ±.";
        } else if (msg.includes('weak-password')) {
            errBox.innerText = "≈ûifre √ßok zayƒ±f (En az 6 karakter).";
        } else if (msg.includes('too-many-requests')) {
            errBox.innerText = "√áok fazla deneme yaptƒ±nƒ±z. Biraz bekleyin.";
        } else {
            errBox.innerText = "Hata: " + msg;
        }
    }

    // --- Dƒ∞L VE TEMA MOTORU ---
    function t(key) { return langPack[appData.lang || localLang][key]; }

    function toggleLang() {
        const current = (auth.currentUser) ? appData.lang : localLang;
        const newLang = current === 'tr' ? 'en' : 'tr';
        
        if(auth.currentUser) { appData.lang = newLang; saveToCloud(); }
        else { localLang = newLang; localStorage.setItem('localLang', newLang); }
        
        applySettingsToDOM(newLang, (auth.currentUser ? appData.theme : localTheme));
        updateUI(); 
        if(document.getElementById('loginPage').style.display !== 'none') {
             if(authMode) showForm(authMode);
        }
    }

    function toggleThemeGlobal() {
        const current = (auth.currentUser) ? appData.theme : localTheme;
        const newTheme = current === 'light' ? 'dark' : 'light';
        
        if(auth.currentUser) { appData.theme = newTheme; saveToCloud(); }
        else { localTheme = newTheme; localStorage.setItem('localTheme', newTheme); }

        applySettingsToDOM((auth.currentUser ? appData.lang : localLang), newTheme);
    }

    function applySettingsToDOM(l, th) {
        document.documentElement.setAttribute('data-theme', th);
        
        const langTxt = l.toUpperCase();
        const themeIcon = th === 'light' ? '‚òÄ' : 'üåô';
        
        document.getElementById('langBtnLogin').innerText = langTxt;
        document.getElementById('langBtnApp').innerText = langTxt;
        document.getElementById('themeBtnLogin').innerText = themeIcon;
        document.getElementById('themeBtnApp').innerText = themeIcon;

        const p = langPack[l];
        document.getElementById('txt_loginSub').innerText = p.loginSub;
        document.getElementById('email').placeholder = p.emailPh;
        document.getElementById('password').placeholder = p.passPh;
        document.getElementById('btn_back').innerText = p.backBtn;
        document.getElementById('btn_welcome_login').innerText = p.welcome_login;
        document.getElementById('btn_welcome_reg').innerText = p.welcome_reg;
        
        document.getElementById('txt_userTitle').innerText = (l==='tr'?'KULLANICI':'USER');
        document.getElementById('menu_home').innerText = p.menu_home;
        document.getElementById('menu_add').innerText = p.menu_add;
        document.getElementById('menu_history').innerText = p.menu_history;
        document.getElementById('menu_profile').innerText = p.menu_profile;
        document.getElementById('menu_logout').innerText = p.menu_logout;
        
        document.getElementById('txt_remind').innerText = p.remind;
        document.getElementById('txt_bodyStat').innerText = p.bodyStat;
        document.getElementById('txt_cur').innerText = p.cur;
        document.getElementById('txt_tar').innerText = p.tar;
        document.getElementById('txt_total').innerText = p.total;
        document.getElementById('txt_step').innerText = p.step;
        document.getElementById('txt_sport').innerText = p.sport;
        document.getElementById('txt_todayWork').innerText = p.todayWork;
        document.getElementById('txt_stepCount').innerText = p.stepCount;
        
        document.getElementById('txt_addAct').innerText = p.addAct;
        document.getElementById('actName').placeholder = p.actNamePh;
        document.getElementById('actCal').placeholder = p.actCalPh;
        document.getElementById('btn_addList').innerText = p.addListBtn;
        document.getElementById('txt_myList').innerText = p.myList;
        
        document.getElementById('txt_histTitle').innerText = p.histTitle;
        document.getElementById('th_date').innerText = p.th_date;
        document.getElementById('th_step').innerText = p.th_step;
        document.getElementById('th_cal').innerText = p.th_cal;
        document.getElementById('btn_clearHist').innerText = p.clearHist;
        
        document.getElementById('txt_settings').innerText = p.settings;
        document.getElementById('lbl_height').innerText = p.lbl_height;
        document.getElementById('lbl_weight').innerText = p.lbl_weight;
        document.getElementById('lbl_target').innerText = p.lbl_target;
        document.getElementById('lbl_freq').innerText = p.lbl_freq;
        document.getElementById('btn_save').innerText = p.saveBtn;
        document.getElementById('txt_endDay').innerText = p.endDay;
        document.getElementById('btn_archive').innerText = p.archBtn;
    }

    // --- DATABASE ---
    function saveToCloud(uid = null) {
        const user = auth.currentUser;
        const targetId = uid || (user ? user.uid : null);
        if(targetId) {
            db.collection('users').doc(targetId).set(appData)
            .catch(e => console.error("Hata", e));
        }
    }

    function loadFromCloud(uid) {
        db.collection('users').doc(uid).get().then(doc => {
            if (doc.exists) {
                appData = doc.data();
                if(!appData.lang) appData.lang = 'tr';
                if(!appData.theme) appData.theme = 'light';
                
                applySettingsToDOM(appData.lang, appData.theme);
                updateUI();
                checkNewDay();
            } else {
                appData = JSON.parse(JSON.stringify(defaultData));
                saveToCloud(uid);
                updateUI();
            }
        });
    }

    // --- UYGULAMA MANTIƒûI ---
    function updateWeightDate() { appData.lastWeightUpdate = new Date().toISOString().split('T')[0]; calculate(); }
    
    function calculate() {
        appData.dailySteps = parseInt(document.getElementById('dailySteps').value) || 0;
        appData.height = parseFloat(document.getElementById('uHeight').value) || 0;
        appData.weight = parseFloat(document.getElementById('uWeight').value) || 0;
        appData.targetWeight = parseFloat(document.getElementById('uTarget').value) || 0;
        appData.weightFreq = parseInt(document.getElementById('uFreq').value) || 7;

        const sCal = Math.round(appData.dailySteps * 0.04);
        let spCal = 0; if(appData.activities) appData.activities.forEach(a => { if(a.completed) spCal += a.cal; });
        
        document.getElementById('totalCal').innerText = sCal + spCal;
        document.getElementById('stepCal').innerText = sCal;
        document.getElementById('sportCal').innerText = spCal;

        if(appData.height > 0 && appData.weight > 0) {
            const h = appData.height/100;
            const bmi = (appData.weight / (h*h)).toFixed(1);
            document.getElementById('bmiValue').innerText = bmi;
            const lbl = document.getElementById('bmiLabel');
            const p = langPack[appData.lang || localLang];
            
            if(bmi<18.5) { lbl.innerText=p.lbl_weak; lbl.style.background="#17a2b8"; }
            else if(bmi<25) { lbl.innerText=p.lbl_normal; lbl.style.background="#28a745"; }
            else if(bmi<30) { lbl.innerText=p.lbl_over; lbl.style.background="#ffc107"; }
            else { lbl.innerText=p.lbl_obese; lbl.style.background="#dc3545"; }
        }
        document.getElementById('curW').innerText = appData.weight;
        document.getElementById('tarW').innerText = appData.targetWeight;
        if(appData.targetWeight > 0) document.getElementById('wProg').style.width = "100%";

        if(appData.lastWeightUpdate) {
            const diff = Math.ceil(Math.abs(new Date() - new Date(appData.lastWeightUpdate)) / 86400000);
            document.getElementById('weightReminder').style.display = (diff > appData.weightFreq) ? 'block' : 'none';
        }
        
        saveToCloud();
        renderTasks();
    }

    function updateUI() {
        document.getElementById('uHeight').value = appData.height || 0;
        document.getElementById('uWeight').value = appData.weight || 0;
        document.getElementById('uTarget').value = appData.targetWeight || 0;
        document.getElementById('uFreq').value = appData.weightFreq || 7;
        document.getElementById('dailySteps').value = appData.dailySteps || 0;
        calculate();
        renderHistory();
        renderManage();
    }

    function addNewActivity() {
        const n = document.getElementById('actName').value;
        const c = parseInt(document.getElementById('actCal').value);
        const l = document.getElementById('actLink').value;
        if(n && c) {
            if(!appData.activities) appData.activities = [];
            appData.activities.push({id:Date.now(), name:n, cal:c, link:l, completed:false});
            document.getElementById('actName').value=''; document.getElementById('actCal').value='';
            updateUI(); alert(t('alert_added'));
        }
    }
    
    function toggleTask(id) {
        const t = appData.activities.find(a=>a.id===id);
        if(t) { t.completed=!t.completed; calculate(); }
    }
    
    function deleteTask(id) {
        if(confirm("Sil/Delete?")) { appData.activities=appData.activities.filter(a=>a.id!==id); updateUI(); }
    }

    function renderTasks() {
        const c = document.getElementById('taskList'); c.innerHTML = '';
        if(appData.activities) {
            appData.activities.forEach(a => {
                c.innerHTML += `<div class="task-item"><input type="checkbox" ${a.completed?'checked':''} onchange="toggleTask(${a.id})" style="width:20px;margin-right:10px;"><div><b>${a.name}</b> (${a.cal} kcal) ${a.link ? `<a href="${a.link}" target="_blank">‚ñ∂</a>`:''}</div></div>`;
            });
        }
    }

    function renderManage() {
        const c = document.getElementById('manageList'); c.innerHTML='';
        if(appData.activities) {
            appData.activities.forEach(a => c.innerHTML += `<div class="task-item"><span>${a.name}</span> <button onclick="deleteTask(${a.id})" style="margin-left:auto;background:#dc3545;color:white;border:none;border-radius:4px;">X</button></div>`);
        }
    }

    function checkNewDay() {
        const t = new Date().toLocaleDateString('tr-TR');
        if(appData.lastDate !== t) { endDay(true); appData.lastDate = t; appData.dailySteps=0; if(appData.activities) appData.activities.forEach(a=>a.completed=false); saveToCloud(); alert(t('alert_newDay')); }
    }

    function endDay(auto=false) {
        if(!auto && !confirm(t('endDay') + "?")) return;
        const s = Math.round((appData.dailySteps || 0) * 0.04);
        let sp = 0; if(appData.activities) appData.activities.forEach(a => { if(a.completed) sp += a.cal; });
        if(s+sp > 0) {
            if(!appData.history) appData.history = [];
            appData.history.unshift({date: appData.lastDate, total: s+sp, steps: appData.dailySteps});
            if(!auto) { appData.dailySteps=0; appData.activities.forEach(a=>a.completed=false); }
            saveToCloud(); updateUI();
        }
    }

    function renderHistory() {
        const tb = document.querySelector('#historyTable tbody'); tb.innerHTML='';
        if(appData.history) {
            appData.history.forEach(h => tb.innerHTML += `<tr><td>${h.date}</td><td>${h.steps}</td><td>${h.total}</td></tr>`);
        }
    }
    function clearHistory() { if(confirm("Clear?")) { appData.history=[]; saveToCloud(); updateUI(); } }

    function openNav() { document.getElementById("mySidebar").style.left = "0"; document.getElementById("overlay").style.display="block"; }
    function closeNav() { document.getElementById("mySidebar").style.left = "-270px"; document.getElementById("overlay").style.display="none"; }
    function switchPage(id) { document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.getElementById(id).classList.add('active'); closeNav(); }

</script>
</body>
</html>
